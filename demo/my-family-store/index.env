<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Store</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ec1380",
                        "background-light": "#f8f6f7",
                        "background-dark": "#221019",
                        "surface-light": "#ffffff",
                        "surface-dark": "#2d1b24",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ec1380;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .snap-x-mandatory {
            scroll-snap-type: x mandatory;
        }

        .snap-center {
            scroll-snap-align: center;
        }

        /* RTL Support */
        [dir="rtl"] .font-display {
            font-family: 'Tahoma', 'Segoe UI', sans-serif;
        }
    </style>
    <script>
        const translations = {
            en: {
                shop: "Shop",
                reviews: "Reviews",
                newColl: "New Collection",
                heroSub: "Detailed quality, fast shipping, and easy returns.",
                footerRights: "Â© 2026. All rights reserved.",
                adminLogin: "Admin Login",
                loading: "Loading Store...",
                search: "Search...",
                orderViaWa: "Order",
                orderBtn: "Order",
                yourDetails: "Your Details",
                namePh: "Your Name",
                phonePh: "Phone Number",
                addrPh: "Delivery Address",
                config: "Configuration",
                inStock: "In Stock",
                // Categories
                cat_all: "All",
                cat_clothing: "Clothing",
                cat_footwear: "Footwear",
                cat_electronics: "Electronics",
                cat_accessories: "Accessories",
                cat_home: "Home & Living",
                cat_custom: "Custom",
                cat_other: "Other",
                searchPlaceholder: "Search products..."
            },
            ar: {
                shop: "ØªØ³ÙˆÙ‚",
                reviews: "Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
                newColl: "ØªØ´ÙƒÙŠÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©",
                heroSub: "Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©ØŒ Ø´Ø­Ù† Ø³Ø±ÙŠØ¹ØŒ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø³Ù‡Ù„.",
                footerRights: "Â© 2026. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.",
                adminLogin: "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„",
                loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
                search: "Ø¨Ø­Ø«...",
                orderViaWa: "Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†",
                orderBtn: "Ø§Ø·Ù„Ø¨",
                yourDetails: "Ø¨ÙŠØ§Ù†Ø§ØªÙƒ",
                namePh: "Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„",
                phonePh: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
                addrPh: "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„",
                config: "Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª",
                inStock: "Ù…ØªÙˆÙØ±",
                // Categories
                cat_all: "Ø§Ù„ÙƒÙ„",
                cat_clothing: "Ù…Ù„Ø§Ø¨Ø³",
                cat_footwear: "Ø£Ø­Ø°ÙŠØ©",
                cat_electronics: "Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª",
                cat_accessories: "Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª",
                cat_home: "Ù…Ù†Ø²Ù„ ÙˆÙ…Ø¹ÙŠØ´Ø©",
                cat_custom: "Ù…Ø®ØµØµ",
                cat_other: "Ø£Ø®Ø±Ù‰",
                searchPlaceholder: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª..."
            }
        };

        function setLanguage(lang) {
            localStorage.setItem('storeLang', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

            // Update Text
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });
            // Update Placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });

            // Toggle Button Text
            const btn = document.getElementById('lang-toggle');
            if (btn) btn.innerText = lang === 'ar' ? 'ðŸ‡ºðŸ‡¸ English' : 'ðŸ‡ªðŸ‡¬ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';

            // Re-render categories/products to fix alignment if needed (optional but good)
            if (typeof renderCategories === 'function') renderCategories();
        }

        function closeAdmin() {
            document.getElementById('app-admin').classList.add('hidden');
        }
    </script>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-gray-900 dark:text-white font-display transition-colors duration-300 antialiased padding-bottom-24">

    <!-- PUBLIC STORE -->
    <div id="app-public">
        <!-- Sticky Header -->
        <header id="store-header"
            class="sticky top-0 z-50 bg-surface-light/90 dark:bg-surface-dark/90 backdrop-blur-md shadow-sm border-b border-gray-100 dark:border-gray-800 transition-colors duration-300">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- Logo & Name -->
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <img id="store-logo-img" src="" class="w-10 h-10 rounded-full object-cover hidden">
                        <div id="store-logo-placeholder"
                            class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold text-lg">
                            S</div>
                        <span id="store-name" class="font-bold text-xl tracking-tight">StyleStore</span>
                    </div>
                    <!-- Nav -->
                    <nav class="hidden md:flex gap-8 font-medium text-sm text-gray-600 dark:text-gray-300">
                        <a class="hover:text-primary transition-colors" href="#products" data-i18n="shop">Shop</a>
                        <a class="hover:text-primary transition-colors" href="#reviews" data-i18n="reviews">Reviews</a>
                        <button id="nav-admin" onclick="toggleAdmin()"
                            class="hover:text-primary transition-colors hidden text-left font-bold text-primary">Admin</button>
                    </nav>
                    <!-- Actions -->
                    <div class="flex items-center gap-3">
                        <button id="lang-toggle"
                            onclick="setLanguage(document.documentElement.lang === 'ar' ? 'en' : 'ar')"
                            class="px-3 py-1.5 rounded-full bg-gray-100 dark:bg-gray-800 text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            ðŸ‡ªðŸ‡¬ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
            <!-- Hero Intro -->
            <section class="text-center space-y-4 py-6">
                <span id="hero-badge"
                    class="inline-block px-4 py-1.5 rounded-full bg-primary/10 text-primary text-xs font-bold uppercase tracking-wider"
                    data-i18n="newColl">New
                    Collection</span>
                <h1 id="hero-title"
                    class="text-4xl sm:text-5xl font-extrabold tracking-tight text-gray-900 dark:text-white leading-tight">
                    Trending Fashion Delivered <br /><span class="text-primary">to Your Doorstep.</span>
                </h1>
                <p id="hero-subtitle" class="max-w-xl mx-auto text-lg text-gray-500 dark:text-gray-400"
                    data-i18n="heroSub">
                    Detailed quality, fast shipping, and easy returns.
                </p>
            </section>

            <!-- Search Bar -->
            <div class="mb-6 max-w-md mx-auto relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <span class="material-icons-round">search</span>
                </span>
                <input type="text" id="public-search" placeholder="Search products..."
                    oninput="handleSearch(this.value)"
                    class="w-full py-3 pl-10 pr-4 rounded-full border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent outline-none shadow-sm transition-all"
                    data-i18n-placeholder="searchPlaceholder">
            </div>

            <!-- Category Filter -->
            <div class="flex overflow-x-auto gap-2 pb-2 scrollbar-hide" id="category-filters">
                <button onclick="filterProducts('all')"
                    class="px-4 py-2 rounded-full bg-primary text-white font-medium text-sm whitespace-nowrap shadow-md">All
                    Products</button>
            </div>

            <!-- Product Grid -->
            <section id="products" class="scroll-mt-24">
                <div id="products-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="loader col-span-full"></div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer
            class="bg-surface-light dark:bg-surface-dark border-t border-gray-200 dark:border-gray-800 pt-10 pb-6 mt-12">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <div class="flex items-center justify-center gap-2 mb-6">
                    <span id="footer-store-name" class="font-bold text-xl tracking-tight">StyleStore</span>
                </div>
                <p class="text-sm text-gray-400" data-i18n="footerRights">Â© 2026. All rights reserved.</p>
                <!-- Admin Button Removed -->
            </div>
        </footer>

        <!-- Floating WhatsApp Removed -->
    </div>

    <!-- PRODUCT DETAILS MODAL (Public) -->
    <div id="details-modal" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm transition-opacity" onclick="closeDetailsModal()">
        </div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto pointer-events-none">
            <div class="flex min-h-full items-center justify-center p-4 sm:p-6 text-center pointer-events-auto">
                <div
                    class="relative transform transition-all w-full max-w-5xl bg-white dark:bg-surface-dark rounded-3xl shadow-2xl flex flex-col overflow-hidden max-h-[90vh]">

                    <!-- Close Button -->
                    <button onclick="closeDetailsModal()"
                        class="absolute top-4 right-4 z-20 p-2 bg-black/10 dark:bg-white/10 hover:bg-red-500 hover:text-white rounded-full transition-colors backdrop-blur-md">
                        <span class="material-icons-round text-xl">close</span>
                    </button>

                    <div class="flex flex-col md:flex-row h-full overflow-hidden">

                        <!-- Left Column: Image Gallery -->
                        <div
                            class="w-full md:w-1/2 bg-gray-100 dark:bg-black/20 p-6 flex flex-col justify-center relative">
                            <!-- Main Image -->
                            <div
                                class="relative w-full aspect-square rounded-2xl overflow-hidden shadow-sm bg-white dark:bg-gray-800 mb-4 group">
                                <img id="view-main-img" src=""
                                    class="w-full h-full object-contain cursor-zoom-in transition-transform duration-500 hover:scale-105">
                                <div id="view-badge"
                                    class="absolute top-4 left-4 bg-primary text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg hidden">
                                    BADGE</div>
                            </div>

                            <!-- Thumbnails -->
                            <div id="view-thumbnails"
                                class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide justify-center px-4">
                                <!-- Thumbnails injected here -->
                            </div>
                        </div>

                        <!-- Right Column: Details & Form -->
                        <div class="w-full md:w-1/2 p-6 sm:p-8 overflow-y-auto bg-white dark:bg-surface-dark text-left">
                            <h2 id="view-name-lg"
                                class="text-3xl font-extrabold text-gray-900 dark:text-white mb-2 leading-tight">Product
                                Name</h2>
                            <div class="flex items-center justify-between mb-6">
                                <span id="view-price" class="text-3xl font-bold text-primary">EGP 0</span>
                                <span
                                    class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide">In
                                    Stock</span>
                            </div>

                            <div class="prose prose-sm dark:prose-invert mb-8 text-gray-600 dark:text-gray-300">
                                <p id="view-desc" class="whitespace-pre-wrap leading-relaxed">Description...</p>
                            </div>

                            <hr class="border-gray-100 dark:border-gray-800 mb-8">

                            <form id="order-form" onsubmit="submitOrder(event)" class="space-y-6">
                                <div>
                                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">
                                        Configuration</h3>
                                    <div id="view-variants" class="space-y-5"></div>
                                </div>

                                <div
                                    class="grid grid-cols-2 gap-4 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-2xl border border-gray-100 dark:border-gray-800">
                                    <h3
                                        class="col-span-2 text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">
                                        Your Details</h3>
                                    <div class="col-span-2 sm:col-span-1">
                                        <input type="text" id="cust-name" required placeholder="Your Name"
                                            class="w-full rounded-xl border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white px-3 py-2.5 text-sm focus:ring-primary focus:border-primary transition-shadow">
                                    </div>
                                    <div class="col-span-2 sm:col-span-1">
                                        <input type="tel" id="cust-phone" required placeholder="Phone Number"
                                            class="w-full rounded-xl border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white px-3 py-2.5 text-sm focus:ring-primary focus:border-primary transition-shadow">
                                    </div>
                                    <div class="col-span-2">
                                        <input type="text" id="cust-address" required placeholder="Delivery Address"
                                            class="w-full rounded-xl border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white px-3 py-2.5 text-sm focus:ring-primary focus:border-primary transition-shadow">
                                    </div>
                                </div>

                                <div class="flex items-center gap-4">
                                    <div
                                        class="flex items-center border border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-800 overflow-hidden shadow-sm">
                                        <button type="button" onclick="adjQty(-1)"
                                            class="px-4 py-3 text-gray-500 hover:text-primary hover:bg-gray-50 dark:hover:bg-gray-700 transition flex items-center justify-center"><span
                                                class="material-icons-round text-sm">remove</span></button>
                                        <input type="number" id="cust-qty" value="1" min="1" readonly
                                            class="w-12 text-center border-none bg-transparent p-0 text-lg font-bold text-gray-900 dark:text-white focus:ring-0">
                                        <button type="button" onclick="adjQty(1)"
                                            class="px-4 py-3 text-gray-500 hover:text-primary hover:bg-gray-50 dark:hover:bg-gray-700 transition flex items-center justify-center"><span
                                                class="material-icons-round text-sm">add</span></button>
                                    </div>
                                    <button type="submit"
                                        class="flex-1 flex justify-center items-center gap-2 rounded-xl bg-[#25D366] hover:bg-[#128C7E] text-white font-bold py-3.5 shadow-lg shadow-green-500/20 transition-all transform hover:-translate-y-0.5">
                                        <span class="text-white text-lg" data-i18n="orderViaWa">Order</span>
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg"
                                            class="w-6 h-6 invert brightness-0">
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ADMIN PANEL -->
    <div id="app-admin" class="fixed inset-0 z-[100] bg-gray-50 dark:bg-gray-900 hidden overflow-y-auto">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Admin Dashboard</h1>
                <div class="flex gap-2">
                    <button onclick="closeAdmin()"
                        class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Back
                        to Store</button>
                    <button onclick="logoutAdmin()"
                        class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition-colors">Logout</button>
                </div>
            </div>

            <div id="admin-login-view" class="max-w-md mx-auto bg-white dark:bg-surface-dark p-8 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-center text-gray-900 dark:text-white">Owner Sign In</h2>
                <div class="space-y-4">
                    <input type="email" id="admin-email" placeholder="Email"
                        class="w-full rounded-lg border-gray-300 px-4 py-3">
                    <input type="password" id="admin-password" placeholder="Password"
                        class="w-full rounded-lg border-gray-300 px-4 py-3">
                    <button onclick="handleLogin()"
                        class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-primary/90">Sign
                        In</button>
                    <div id="admin-signup-link" class="text-center text-sm"><a href="#" onclick="toggleSignup()"
                            class="text-primary hover:underline">Create Account</a></div>
                </div>
            </div>
            <div id="admin-signup-view"
                class="max-w-md mx-auto bg-white dark:bg-surface-dark p-8 rounded-2xl shadow-lg hidden">
                <h2 class="text-xl font-bold mb-4 text-center text-gray-900 dark:text-white">Create Account</h2>
                <div class="space-y-4">
                    <input type="email" id="signup-email" placeholder="Email"
                        class="w-full rounded-lg border-gray-300 px-4 py-3">
                    <input type="password" id="signup-password" placeholder="Password"
                        class="w-full rounded-lg border-gray-300 px-4 py-3">
                    <button onclick="handleSignup()"
                        class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-primary/90">Create
                        Account</button>
                    <div class="text-center text-sm"><a href="#" onclick="toggleSignup()" class="text-gray-500">Back to
                            Login</a></div>
                </div>
            </div>

            <div id="admin-dashboard-view" class="hidden space-y-6">
                <div class="flex space-x-1 rounded-xl bg-gray-200 dark:bg-gray-800 p-1">
                    <button onclick="showTab('products')"
                        class="w-full rounded-lg py-2.5 text-sm font-medium leading-5 text-gray-700 bg-white shadow focus:ring-2">Products</button>
                    <button onclick="showTab('orders')"
                        class="w-full rounded-lg py-2.5 text-sm font-medium leading-5 text-gray-700 hover:bg-white/[0.12]">Orders</button>
                    <button onclick="showTab('settings')"
                        class="w-full rounded-lg py-2.5 text-sm font-medium leading-5 text-gray-700 hover:bg-white/[0.12]">Settings</button>
                </div>

                <div id="tab-products">
                    <button onclick="openProductModal()"
                        class="mb-4 bg-primary text-white px-4 py-2 rounded-lg font-bold hover:bg-primary/90">+ Add
                        Product</button>
                    <div id="admin-products-list" class="grid gap-4"></div>
                </div>

                <div id="tab-orders" class="hidden">
                    <div id="admin-orders-list" class="space-y-4"></div>
                </div>

                <div id="tab-settings" class="hidden bg-white dark:bg-surface-dark p-6 rounded-xl shadow-sm space-y-4">
                    <h3 class="text-lg font-bold">Store Configuration</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Store Name</label>
                            <input type="text" id="set-store-name"
                                class="mt-1 w-full rounded-md border-gray-300 h-10 px-3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">WhatsApp Number</label>
                            <input type="text" id="set-whatsapp"
                                class="mt-1 w-full rounded-md border-gray-300 h-10 px-3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Store Logo</label>
                            <div class="flex gap-2 items-center mt-1">
                                <img id="logo-preview" src=""
                                    class="w-10 h-10 rounded-full object-cover bg-gray-100 hidden">
                                <input type="file" id="set-logo-file" accept="image/*"
                                    class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                            </div>
                            <input type="hidden" id="set-logo-url"> <!-- Hidden input to store URL -->
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Owner Login Email</label>
                            <input type="email" id="set-owner-email"
                                class="mt-1 w-full rounded-md border-gray-300 h-10 px-3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Primary Color</label>
                            <input type="color" id="set-color"
                                class="mt-1 w-full h-10 rounded-md border-gray-300 cursor-pointer">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Header Main Title</label>
                            <input type="text" id="set-header-title" placeholder="Trending Fashion Delivered"
                                class="mt-1 w-full rounded-md border-gray-300 h-10 px-3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Header Accent (Colored)</label>
                            <input type="text" id="set-header-subtitle" placeholder="to Your Doorstep."
                                class="mt-1 w-full rounded-md border-gray-300 h-10 px-3">
                        </div>
                    </div>
                    <button onclick="saveSettings()"
                        class="bg-primary text-white px-6 py-2 rounded-lg font-bold hover:bg-primary/90">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRODUCT MODAL (Admin) - With File Upload -->
    <div id="product-modal" class="fixed inset-0 z-[110] hidden" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/75 backdrop-blur-sm"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="bg-white dark:bg-surface-dark w-full max-w-2xl rounded-2xl p-6 shadow-xl border border-gray-100 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="prod-modal-title" class="text-xl font-bold">Add Product</h2>
                        <button onclick="closeProductModal()" class="text-gray-400"><span
                                class="material-icons-round">close</span></button>
                    </div>
                    <form id="product-form" onsubmit="saveProduct(event)" class="space-y-4">
                        <input type="hidden" id="prod-id">

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">Name</label>
                                <input type="text" id="prod-name" required
                                    class="w-full rounded-lg border-gray-300 px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Price</label>
                                <div class="flex gap-2">
                                    <input type="number" id="prod-price" required
                                        class="flex-1 rounded-lg border-gray-300 px-3 py-2">
                                    <select id="prod-currency"
                                        class="w-24 rounded-lg border-gray-300 px-3 py-2 bg-white">
                                        <option value="EGP">EGP</option>
                                        <option value="IQD">IQD</option>
                                        <option value="USD">USD</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium">Description</label>
                            <textarea id="prod-desc" rows="3" class="w-full rounded-lg border-gray-300 px-3 py-2"
                                placeholder="Describe your product..."></textarea>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Product Images</label>

                            <!-- File Input -->
                            <input type="file" id="prod-files" multiple accept="image/*" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-primary/10 file:text-primary
                                hover:file:bg-primary/20
                              " />

                            <!-- Progress Bar -->
                            <div id="upload-progress-container"
                                class="hidden w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mt-2">
                                <div id="upload-progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%">
                                </div>
                            </div>

                            <!-- Manual URL Fallback (optional, keeping it hidden or as alternative) -->
                            <details class="text-xs">
                                <summary class="cursor-pointer text-gray-500 hover:text-gray-700">Or paste image URLs
                                    directly</summary>
                                <input type="text" id="prod-images-manual" placeholder="https://..."
                                    class="mt-2 w-full rounded-lg border-gray-300 px-3 py-2">
                            </details>

                            <div id="preview-images" class="flex gap-2 overflow-x-auto py-2"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Category</label>
                                <select id="prod-category" onchange="updateVariantPresets()"
                                    class="w-full rounded-lg border-gray-300 px-3 py-2">
                                    <option value="clothing">Clothing</option>
                                    <option value="footwear">Footwear</option>
                                    <option value="electronics">Electronics</option>
                                    <option value="accessories">Accessories</option>
                                    <option value="home">Home & Living</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Badge (Optional)</label>
                                <input type="text" id="prod-badge" placeholder="New, Sale..."
                                    class="w-full rounded-lg border-gray-300 px-3 py-2">
                            </div>
                        </div>

                        <div
                            class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                            <label class="block text-sm font-bold mb-2">Variants (Size, Color, etc.)</label>
                            <div id="variant-builder" class="space-y-2"></div>
                            <button type="button" onclick="addVariantRow()"
                                class="mt-2 text-primary text-sm font-bold">+ Add Option Type</button>
                        </div>

                        <button type="submit" id="btn-save-prod"
                            class="w-full bg-primary text-white font-bold py-3 rounded-lg">Save Product</button>
                    </form>
                    <button onclick="deleteProduct()" id="btn-delete-prod"
                        class="w-full mt-3 bg-red-100 text-red-600 font-bold py-3 rounded-lg hover:bg-red-200 hidden">Delete
                        Product</button>
                </div>
            </div>
        </div>
    </div>

    <div id="initial-loader"
        class="fixed inset-0 z-[9999] bg-white dark:bg-surface-dark flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 dark:text-gray-400 font-medium animate-pulse">Loading Store...</p>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Storage Removed for ImgBB -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script> -->

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCrYbhT2_UXtFDck-wqqb11cD3gdyu_53g",
            authDomain: "store-temp1.firebaseapp.com",
            projectId: "store-temp1",
            storageBucket: "store-temp1.firebasestorage.app",
            messagingSenderId: "57188071865",
            appId: "1:57188071865:web:7ef9f96492ca9221fe9e68"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        // Remove storage init since we are using ImgBB
        // const storage = firebase.storage(); 
        const STORE_ID = "main-store";

        let currentProduct = null;
        let storeSettings = {
            name: "StyleStore",
            whatsapp: "201000000000",
            primaryColor: "#ec1380",
            logoUrl: "",
            headerTitle: "Trending Fashion Delivered",
            headerSubtitle: "to Your Doorstep.",
            ownerEmail: "" // Tracks the single owner
        };
        let products = [];
        let activeCategory = 'all';
        let activeSearchQuery = '';

        window.addEventListener('DOMContentLoaded', async () => {
            const loader = document.getElementById('initial-loader');

            // Init Language
            const storedLang = localStorage.getItem('storeLang') || 'en';
            setLanguage(storedLang);

            try { await Promise.all([loadStoreSettings(), loadProducts()]); } catch (error) { console.error(error); }
            finally { if (loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); } }

            // Check for ?admin param
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('admin')) {
                toggleAdmin();
                // If we have an owner, and no user is logged in, ensure signup is hidden
                checkSignupVisibility();
            }

            auth.onAuthStateChanged(user => {
                const adminBtn = document.getElementById('nav-admin');
                if (user) {
                    if (adminBtn) adminBtn.classList.remove('hidden');
                    initAdmin();
                    // If user is logged in, ensure admin view is open even without param (optional, but good UX if they just logged in)
                    // But we'll stick to param trigger for opening the view initially if not already open
                    if (!document.getElementById('app-admin').classList.contains('hidden')) {
                        // Already open
                    }
                } else {
                    if (adminBtn) adminBtn.classList.add('hidden');
                    document.getElementById('admin-dashboard-view').classList.add('hidden');
                    document.getElementById('admin-login-view').classList.remove('hidden');
                    checkSignupVisibility();
                }
            });
        });

        // --- CORE SETTINGS ---
        async function loadStoreSettings() {
            try {
                const doc = await db.collection('stores').doc(STORE_ID).get();
                if (doc.exists) { storeSettings = { ...storeSettings, ...doc.data() }; applySettings(); }
            } catch (e) { console.error(e); }
        }

        function checkSignupVisibility() {
            const signupLink = document.getElementById('admin-signup-link');
            if (storeSettings.ownerEmail) {
                if (signupLink) signupLink.classList.add('hidden');
            } else {
                if (signupLink) signupLink.classList.remove('hidden');
            }
        }


        function applySettings() {
            if (storeSettings.primaryColor) {
                document.documentElement.style.setProperty('--color-primary', storeSettings.primaryColor);
                const style = document.createElement('style');
                style.innerHTML = `.text-primary { color: ${storeSettings.primaryColor} !important; } .bg-primary { background-color: ${storeSettings.primaryColor} !important; } .border-primary { border-color: ${storeSettings.primaryColor} !important; } .ring-primary { --tw-ring-color: ${storeSettings.primaryColor} !important; }`;
                document.head.appendChild(style);
            }
            document.getElementById('store-name').innerText = storeSettings.name;
            document.title = storeSettings.name;
            document.getElementById('footer-store-name').innerText = storeSettings.name;

            const logoImg = document.getElementById('store-logo-img');
            const logoPlace = document.getElementById('store-logo-placeholder');
            const logoUrl = storeSettings.logoUrl;

            if (logoUrl) {
                logoImg.src = logoUrl; logoImg.classList.remove('hidden'); logoPlace.classList.add('hidden');
            } else {
                logoImg.classList.add('hidden'); logoPlace.classList.remove('hidden'); logoPlace.innerText = storeSettings.name.charAt(0);
            }

            // Edit both parts of header
            const hTitle = storeSettings.headerTitle || "Trending Fashion Delivered";
            const hSub = storeSettings.headerSubtitle || "to Your Doorstep.";
            document.getElementById('hero-title').innerHTML = `${hTitle} <br/><span class="text-primary">${hSub}</span>`;

            // const waLink = `https://wa.me/${storeSettings.whatsapp}`;
            // document.getElementById('header-whatsapp-btn').href = waLink;

            // Update inputs
            document.getElementById('set-store-name').value = storeSettings.name;
            document.getElementById('set-whatsapp').value = storeSettings.whatsapp;
            document.getElementById('set-color').value = storeSettings.primaryColor;

            // Logo Logic
            document.getElementById('set-logo-url').value = logoUrl || '';
            const logoPreview = document.getElementById('logo-preview');
            if (logoUrl) { logoPreview.src = logoUrl; logoPreview.classList.remove('hidden'); }
            else { logoPreview.classList.add('hidden'); }

            document.getElementById('set-header-title').value = storeSettings.headerTitle || '';

            // Check if subtitle input exists (might not be if we haven't updated HTML yet, but safe to try)
            const subInput = document.getElementById('set-header-subtitle');
            if (subInput) subInput.value = storeSettings.headerSubtitle || '';

            const ownerInput = document.getElementById('set-owner-email');
            if (ownerInput) ownerInput.value = storeSettings.ownerEmail || (auth.currentUser ? auth.currentUser.email : '');

            checkSignupVisibility();
        }

        async function saveSettings() {
            const btn = document.querySelector('button[onclick="saveSettings()"]');
            const oldText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                const newEmail = document.getElementById('set-owner-email').value;
                let emailChanged = false;

                // 1. Try to update Auth Email if changed
                if (auth.currentUser && newEmail && newEmail !== auth.currentUser.email) {
                    await auth.currentUser.updateEmail(newEmail);
                    emailChanged = true;
                }

                // 2. Handle Logo Upload
                const logoFile = document.getElementById('set-logo-file').files[0];
                let finalLogoUrl = document.getElementById('set-logo-url').value;

                if (logoFile) {
                    btn.innerText = "Uploading Logo...";
                    const formData = new FormData();
                    formData.append("image", logoFile);
                    // Use the same demo key or user provided key logic
                    const IMGBB_API_KEY = "2be2ea92506e46944e941ac5f061c526";
                    formData.append("key", IMGBB_API_KEY);

                    const response = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: formData });
                    const result = await response.json();

                    if (result.success) {
                        finalLogoUrl = result.data.url;
                    } else {
                        throw new Error("Logo Upload Failed: " + (result.error ? result.error.message : "Unknown error"));
                    }
                }

                btn.innerText = "Saving Settings...";

                const newSettings = {
                    name: document.getElementById('set-store-name').value,
                    whatsapp: document.getElementById('set-whatsapp').value.replace(/[^0-9]/g, ''),
                    primaryColor: document.getElementById('set-color').value,
                    logoUrl: finalLogoUrl,
                    headerTitle: document.getElementById('set-header-title').value,
                    headerSubtitle: document.getElementById('set-header-subtitle').value,
                    ownerEmail: newEmail
                };

                await db.collection('stores').doc(STORE_ID).update(newSettings);
                storeSettings = { ...storeSettings, ...newSettings };
                applySettings();

                alert(emailChanged ? "Settings & Email Saved! New email is active." : "Settings Saved!");

                // Clear file input
                document.getElementById('set-logo-file').value = '';

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = oldText;
            }
        }

        function handleSearch(query) {
            activeSearchQuery = query.toLowerCase().trim();
            renderPublicProducts();
        }

        // --- PRODUCT LOGIC ---
        async function loadProducts() {
            try {
                const snapshot = await db.collection('products').where('store_id', '==', STORE_ID).orderBy('createdAt', 'desc').get();
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategories();
                renderPublicProducts();
                renderAdminProducts();
            } catch (e) {
                console.error(e);
                // Fallback for index error (needs index on store_id + createdAt)
                if (e.code === 'failed-precondition') {
                    const snapshot = await db.collection('products').where('store_id', '==', STORE_ID).get();
                    products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCategories(); renderPublicProducts(); renderAdminProducts();
                }
            }
        }

        function renderCategories() {
            const categories = new Set(products.map(p => p.category || 'other'));
            const container = document.getElementById('category-filters');
            const lang = document.documentElement.lang || 'en';

            // Helper to get translated category name
            const getCatName = (c) => translations[lang][`cat_${c}`] || translations[lang]['cat_other'] || c;

            let html = `<button onclick="filterProducts('all')" class="px-5 py-2 rounded-full ${activeCategory === 'all' ? 'bg-primary text-white shadow-lg' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700'} font-bold text-sm whitespace-nowrap transition-all">${translations[lang]['cat_all']}</button>`;

            categories.forEach(cat => {
                const isActive = activeCategory === cat;
                const label = getCatName(cat);
                html += `<button onclick="filterProducts('${cat}')" class="px-5 py-2 rounded-full ${isActive ? 'bg-primary text-white shadow-lg' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700'} font-bold text-sm whitespace-nowrap transition-all">${label}</button>`;
            });
            container.innerHTML = html;
        }

        function filterProducts(cat) { activeCategory = cat; renderCategories(); renderPublicProducts(); }

        function renderPublicProducts() {
            const list = document.getElementById('products-list');

            let filtered = products;

            // 1. Filter by Category
            if (activeCategory !== 'all') {
                filtered = filtered.filter(p => (p.category || 'other') === activeCategory);
            }

            // 2. Filter by Search
            if (activeSearchQuery) {
                filtered = filtered.filter(p =>
                    p.name.toLowerCase().includes(activeSearchQuery) ||
                    (p.description && p.description.toLowerCase().includes(activeSearchQuery))
                );
            }

            const lang = document.documentElement.lang || 'en';

            if (filtered.length === 0) list.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">No products found.</p>';
            else {
                list.innerHTML = filtered.map(p => {
                    const img = (p.images && p.images.length > 0) ? p.images[0] : (p.image || 'https://placehold.co/400');
                    return `
                    <div class="group bg-surface-light dark:bg-surface-dark rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 dark:border-gray-800 relative flex flex-col h-full cursor-pointer" onclick="openDetailsModal('${p.id}')">
                        <div class="aspect-[4/5] bg-gray-200 relative overflow-hidden">
                            <img src="${img}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                            ${p.badge ? `<div class="absolute top-3 right-3 bg-white/95 dark:bg-black/80 backdrop-blur text-xs font-bold px-2 py-1 rounded-full shadow-sm">${p.badge}</div>` : ''}
                        </div>
                        <div class="p-4 flex flex-col flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg leading-tight group-hover:text-primary transition-colors text-gray-900 dark:text-white line-clamp-2">${p.name}</h3>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3 line-clamp-2">${p.description || ''}</p>
                            <div class="mt-auto flex justify-between items-center">
                                <span class="font-bold text-primary text-xl">${p.price} ${p.currency || 'EGP'}</span>
                                <button class="bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-4 py-2 rounded-full font-bold text-sm hover:bg-primary dark:hover:bg-primary hover:text-white dark:hover:text-white transition-colors" data-i18n="orderBtn">
                                    ${translations[lang]['orderBtn']}
                                </button>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }
        }

        function renderAdminProducts() {
            const list = document.getElementById('admin-products-list');
            list.innerHTML = products.map(p => `
                <div class="flex items-center justify-between p-4 bg-white dark:bg-surface-dark border border-gray-100 dark:border-gray-700 rounded-lg shadow-sm">
                    <div class="flex items-center gap-4">
                        <img src="${(p.images && p.images.length > 0) ? p.images[0] : (p.image || '')}" class="w-12 h-12 rounded-lg object-cover bg-gray-100">
                        <div>
                            <h4 class="font-bold text-gray-900 dark:text-white">${p.name}</h4>
                            <p class="text-xs text-gray-400"> ${p.category || 'No Category'}</p>
                        </div>
                    </div>
                    <button onclick="openProductModal('${p.id}')" class="text-gray-400 hover:text-primary"><span class="material-icons-round">edit</span></button>
                </div>
            `).join('');
        }

        function openDetailsModal(id) {
            const p = products.find(x => x.id === id);
            if (!p) return;
            currentProduct = p;

            // Text Inputs
            document.getElementById('view-name-lg').innerText = p.name;
            document.getElementById('view-name-lg').innerText = p.name;
            document.getElementById('view-price').innerText = `${p.price} ${p.currency || 'EGP'}`;
            document.getElementById('view-desc').innerText = p.description || "No description.";

            // Badge
            const badgeEl = document.getElementById('view-badge');
            if (p.badge) { badgeEl.innerText = p.badge; badgeEl.classList.remove('hidden'); } else { badgeEl.classList.add('hidden'); }

            // Images Logic
            const images = (p.images && p.images.length > 0) ? p.images : (p.image ? [p.image] : []);
            if (images.length === 0) images.push('https://placehold.co/600x600?text=No+Image');

            // Set Main Image (First one)
            setMainImage(images[0]);

            // Render Thumbnails
            const thumbContainer = document.getElementById('view-thumbnails');
            if (images.length > 1) {
                thumbContainer.innerHTML = images.map((src, i) => `
                    <button onclick="setMainImage('${src}')" class="shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 border-transparent hover:border-primary focus:border-primary transition-all p-0.5">
                        <img src="${src}" class="w-full h-full object-cover rounded-md">
                    </button>
                `).join('');
                thumbContainer.classList.remove('hidden');
            } else {
                thumbContainer.innerHTML = '';
                thumbContainer.classList.add('hidden');
            }

            // Variants
            const variantContainer = document.getElementById('view-variants');
            variantContainer.innerHTML = '';

            if (p.variants && p.variants.length > 0) {
                p.variants.forEach((v, index) => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label class="block text-sm font-bold text-gray-900 dark:text-white mb-2">${v.name}</label>
                        <div class="flex flex-wrap gap-2">
                            ${v.values.map((val, vIdx) => `
                                <label class="cursor-pointer relative">
                                    <input type="radio" name="variant_${index}" value="${val}" class="peer sr-only" required ${vIdx === 0 ? 'checked' : ''}>
                                    <span class="block px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm font-medium text-gray-600 dark:text-gray-300 peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary peer-checked:shadow-lg transition-all transform peer-checked:scale-105">
                                        ${val}
                                    </span>
                                </label>
                            `).join('')}
                        </div>`;
                    variantContainer.appendChild(div);
                });
            } else {
                variantContainer.innerHTML = '<p class="text-sm text-gray-400 italic">Standard configuration</p>';
            }

            document.getElementById('cust-qty').value = 1;
            document.getElementById('details-modal').classList.remove('hidden');
        }

        function setMainImage(src) {
            const img = document.getElementById('view-main-img');
            // Simple fade transition or direct switch
            img.style.opacity = '0.5';
            setTimeout(() => {
                img.src = src;
                img.style.opacity = '1';
            }, 150);
        }

        function closeDetailsModal() { document.getElementById('details-modal').classList.add('hidden'); }
        function adjQty(amount) { const el = document.getElementById('cust-qty'); let val = parseInt(el.value) + amount; if (val < 1) val = 1; el.value = val; }

        function submitOrder(e) {
            e.preventDefault();
            const variantSelections = [];
            if (currentProduct.variants) {
                currentProduct.variants.forEach((v, index) => {
                    const selected = document.querySelector(`input[name="variant_${index}"]:checked`);
                    variantSelections.push(selected ? `${v.name}: ${selected.value}` : '');
                });
            }
            const variantString = variantSelections.filter(x => x).join(', ') || 'Standard';
            const data = {
                store_id: STORE_ID,
                productName: currentProduct.name,
                price: currentProduct.price,
                customerName: document.getElementById('cust-name').value,
                customerPhone: document.getElementById('cust-phone').value,
                customerAddress: document.getElementById('cust-address').value,
                quantity: document.getElementById('cust-qty').value,
                variantDetails: variantString,
                status: "Sent to WhatsApp", // Default status
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            db.collection('orders').add(data).catch(console.error);
            const message = `Hello, I want to order:%0AðŸ“¦ *Product:* ${data.productName}%0AðŸ’° *Total:* ${data.price * data.quantity} ${currentProduct.currency || 'EGP'}%0AðŸ”¢ *Qty:* ${data.quantity}%0AðŸŽ¨ *Spec:* ${data.variantDetails}%0AðŸ‘¤ *Name:* ${data.customerName}%0AðŸ“± *Phone:* ${data.customerPhone}%0AðŸ  *Address:* ${data.customerAddress}`;
            window.open(`https://wa.me/${storeSettings.whatsapp}?text=${message}`, '_blank');
            closeDetailsModal();
        }

        // --- ADMIN MODAL & CRUD ---
        function addVariantRow(name = '', values = '') {
            const container = document.getElementById('variant-builder');
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center';
            div.innerHTML = `<input type="text" placeholder="Name (Size)" value="${name}" class="variant-name w-1/3 rounded-lg border-gray-300 px-2 py-2 text-sm">
                <input type="text" placeholder="Values (S, M, L)" value="${values}" class="variant-values flex-1 rounded-lg border-gray-300 px-2 py-2 text-sm">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold px-2">&times;</button>`;
            container.appendChild(div);
        }

        function updateVariantPresets() {
            const category = document.getElementById('prod-category').value;
            const container = document.getElementById('variant-builder');
            container.innerHTML = '';
            if (category === 'clothing') { addVariantRow('Size', 'S, M, L, XL'); addVariantRow('Color', 'Red, Blue, Black'); }
            else if (category === 'footwear') { addVariantRow('Size', '38, 39, 40, 41, 42'); addVariantRow('Color', 'Black, White'); }
            else { addVariantRow('', ''); }
        }

        function getVariantsFromForm() {
            const rows = document.querySelectorAll('#variant-builder > div');
            const variants = [];
            rows.forEach(row => {
                const name = row.querySelector('.variant-name').value.trim();
                const values = row.querySelector('.variant-values').value.split(',').map(s => s.trim()).filter(s => s);
                if (name && values.length > 0) variants.push({ name, values });
            });
            return variants;
        }

        function openProductModal(id = null) {
            document.getElementById('product-modal').classList.remove('hidden');
            const delBtn = document.getElementById('btn-delete-prod');
            document.getElementById('prod-modal-title').innerText = id ? "Edit Product" : "Add Product";
            const container = document.getElementById('variant-builder');
            container.innerHTML = '';

            // Preview clearing
            document.getElementById('preview-images').innerHTML = '';
            document.getElementById('upload-progress-container').classList.add('hidden');
            document.getElementById('prod-files').value = '';

            if (id) {
                const p = products.find(x => x.id === id);
                document.getElementById('prod-id').value = p.id;
                document.getElementById('prod-name').value = p.name;
                document.getElementById('prod-name').value = p.name;
                document.getElementById('prod-price').value = p.price;
                document.getElementById('prod-currency').value = p.currency || 'EGP';
                document.getElementById('prod-desc').value = p.description || '';

                const imgs = (p.images && p.images.length > 0) ? p.images : (p.image ? [p.image] : []);
                // Show existing images in preview
                const previewDiv = document.getElementById('preview-images');
                imgs.forEach(url => {
                    previewDiv.innerHTML += `<img src="${url}" class="h-10 w-10 object-cover rounded shadow-sm border">`;
                });

                document.getElementById('prod-images-manual').value = imgs.join(', ');
                document.getElementById('prod-badge').value = p.badge || '';
                document.getElementById('prod-category').value = p.category || 'clothing';

                if (p.variants && p.variants.length > 0) p.variants.forEach(v => addVariantRow(v.name, v.values.join(', ')));
                else updateVariantPresets();
                delBtn.classList.remove('hidden');
            } else {
                document.getElementById('product-form').reset();
                document.getElementById('prod-currency').value = 'EGP';
                document.getElementById('prod-id').value = '';
                document.getElementById('prod-category').value = 'clothing';
                updateVariantPresets();
                delBtn.classList.add('hidden');
            }
        }
        function closeProductModal() { document.getElementById('product-modal').classList.add('hidden'); }

        async function saveProduct(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-prod');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Starting Upload...";

            try {
                const id = document.getElementById('prod-id').value;
                const name = document.getElementById('prod-name').value;
                const price = document.getElementById('prod-price').value;
                if (!name || !price) throw new Error("Name and Price are required.");

                const manualImgs = document.getElementById('prod-images-manual').value.split(',').map(s => s.trim()).filter(x => x);
                const fileInput = document.getElementById('prod-files');
                const uploadedUrls = [];

                // ImgBB Upload Logic
                if (fileInput.files.length > 0) {
                    const progressContainer = document.getElementById('upload-progress-container');
                    const progressBar = document.getElementById('upload-progress-bar');
                    progressContainer.classList.remove('hidden');

                    // You can get a free key from https://api.imgbb.com/
                    // Using a public demo key or user needs to provide one. 
                    //Ideally, we'd store this in settings, but for now we'll use a placeholder or ask user.
                    // IMPORTANT: This is a demo key, user should replace it.
                    const IMGBB_API_KEY = "2be2ea92506e46944e941ac5f061c526"; // User provided key

                    for (let i = 0; i < fileInput.files.length; i++) {
                        const file = fileInput.files[i];
                        btn.innerText = `Uploading ${i + 1}/${fileInput.files.length}...`;

                        const formData = new FormData();
                        formData.append("image", file);
                        formData.append("key", IMGBB_API_KEY);

                        const response = await fetch("https://api.imgbb.com/1/upload", {
                            method: "POST",
                            body: formData
                        });

                        const result = await response.json();
                        if (result.success) {
                            uploadedUrls.push(result.data.url);
                            const pct = ((i + 1) / fileInput.files.length) * 100;
                            progressBar.style.width = `${pct}%`;
                        } else {
                            throw new Error("ImgBB Error: " + (result.error ? result.error.message : "Upload failed"));
                        }
                    }
                }

                btn.innerText = "Saving Data...";
                const finalImages = [...uploadedUrls, ...manualImgs];

                const data = {
                    store_id: STORE_ID,
                    name: name,
                    price: Number(price),
                    currency: document.getElementById('prod-currency').value,
                    description: document.getElementById('prod-desc').value,
                    images: finalImages,
                    image: finalImages.length > 0 ? finalImages[0] : '',
                    badge: document.getElementById('prod-badge').value,
                    category: document.getElementById('prod-category').value,
                    variants: getVariantsFromForm(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (id) await db.collection('products').doc(id).update(data);
                else await db.collection('products').add({ ...data, createdAt: firebase.firestore.FieldValue.serverTimestamp() });

                closeProductModal();
                loadProducts();
                alert("Product Saved Successfully!");

            } catch (err) {
                console.error("Save failed:", err);
                alert("Error saving: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
                document.getElementById('upload-progress-container').classList.add('hidden');
            }
        }

        async function deleteProduct() {
            if (!confirm("Delete?")) return;
            const id = document.getElementById('prod-id').value;
            if (id) { await db.collection('products').doc(id).delete(); closeProductModal(); loadProducts(); }
        }

        // --- AUTH ---
        function toggleAdmin() { document.getElementById('app-admin').classList.remove('hidden'); }
        function toggleSignup() { document.getElementById('admin-login-view').classList.toggle('hidden'); document.getElementById('admin-signup-view').classList.toggle('hidden'); }
        function handleLogin() { auth.signInWithEmailAndPassword(document.getElementById('admin-email').value, document.getElementById('admin-password').value).catch(alert); }
        function handleSignup() {
            const email = document.getElementById('signup-email').value;
            auth.createUserWithEmailAndPassword(email, document.getElementById('signup-password').value).then(async () => {
                // Determine if this is the first owner
                if (!storeSettings.ownerEmail) {
                    await db.collection('stores').doc(STORE_ID).set({ ownerEmail: email }, { merge: true });
                    storeSettings.ownerEmail = email;
                }
                alert("Account Created!");
                toggleSignup();
                // Reload settings to ensure UI updates (hides signup)
                loadStoreSettings();
            }).catch(alert);
        }
        function logoutAdmin() { auth.signOut().then(() => { document.getElementById('admin-dashboard-view').classList.add('hidden'); document.getElementById('admin-login-view').classList.remove('hidden'); }); }
        function initAdmin() { document.getElementById('admin-login-view').classList.add('hidden'); document.getElementById('admin-signup-view').classList.add('hidden'); document.getElementById('admin-dashboard-view').classList.remove('hidden'); loadAdminOrders(); }
        function showTab(tab) { document.querySelectorAll('#admin-dashboard-view > div[id^="tab-"]').forEach(el => el.classList.add('hidden')); document.getElementById(`tab-${tab}`).classList.remove('hidden'); if (tab === 'orders') loadAdminOrders(); }
        async function loadAdminOrders() {
            const list = document.getElementById('admin-orders-list');
            list.innerHTML = '<div class="flex justify-center py-8"><div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div></div>';

            try {
                // Fetch orders - Removed orderBy to prevent "Missing Index" errors on new stores
                const snap = await db.collection('orders')
                    .where('store_id', '==', STORE_ID)
                    .limit(50)
                    .get();

                if (snap.empty) {
                    list.innerHTML = `
                        <div class="text-center py-8">
                            <span class="material-icons-round text-4xl text-gray-300 block mb-2">assignment</span>
                            <p class="text-gray-500">No orders found.</p>
                        </div>`;
                    return;
                }

                // Sort client-side
                const docs = snap.docs.sort((a, b) => {
                    const tA = a.data().timestamp ? a.data().timestamp.toMillis() : 0;
                    const tB = b.data().timestamp ? b.data().timestamp.toMillis() : 0;
                    return tB - tA; // Newest first
                });

                list.innerHTML = docs.map(d => {
                    const data = d.data();
                    const id = d.id;
                    const status = data.status || "Sent to WhatsApp";

                    let statusColor = "bg-yellow-100 text-yellow-800";
                    if (status === "Confirmed") statusColor = "bg-blue-100 text-blue-800";
                    if (status === "Delivered") statusColor = "bg-green-100 text-green-800";

                    return `
                        <div class="bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 border-l-4 ${status === 'Delivered' ? 'border-l-green-500' : (status === 'Confirmed' ? 'border-l-blue-500' : 'border-l-yellow-500')} transition-all hover:shadow-md">
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-3 gap-2">
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white text-lg">${data.productName} <span class="text-sm font-normal text-gray-500">x${data.quantity}</span></span>
                                    <div class="text-xs text-gray-400 mt-1">${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : ''}</div>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider ${statusColor} text-center w-fit">${status}</span>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-600 dark:text-gray-300 mb-4 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                                <div>
                                    <div class="font-bold text-gray-500 text-xs uppercase mb-1">Variant</div>
                                    <div class="font-semibold text-primary">${data.variantDetails || 'Standard'}</div>
                                </div>
                                <div>
                                    <div class="font-bold text-gray-500 text-xs uppercase mb-1">Customer</div>
                                    <div>${data.customerName}</div>
                                    <div><a href="tel:${data.customerPhone}" class="hover:text-primary underline font-medium">${data.customerPhone}</a></div>
                                </div>
                                <div class="col-span-full">
                                    <div class="font-bold text-gray-500 text-xs uppercase mb-1">Address</div>
                                    <div class="break-words">${data.customerAddress}</div>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-2 justify-end pt-3 border-t border-gray-100 dark:border-gray-700">
                                ${status !== 'Confirmed' && status !== 'Delivered' ? `<button onclick="updateOrderStatus('${id}', 'Confirmed')" class="px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg text-sm font-bold transition-colors">Confirm Order</button>` : ''}
                                ${status !== 'Delivered' ? `<button onclick="updateOrderStatus('${id}', 'Delivered')" class="px-4 py-2 bg-green-50 hover:bg-green-100 text-green-600 rounded-lg text-sm font-bold transition-colors">Mark Delivered</button>` : ''}
                                <button onclick="deleteOrder('${id}')" class="px-3 py-2 text-red-400 hover:text-red-500 hover:bg-red-50 rounded-lg text-sm transition-colors border border-transparent hover:border-red-100"><span class="material-icons-round text-lg">delete</span></button>
                            </div>
                        </div>`;
                }).join('');
            } catch (err) {
                console.error("Order Load Error:", err);
                list.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-center">
                        <p class="text-red-600 font-bold mb-1">Failed to load orders</p>
                        <p class="text-xs text-red-500 break-all">${err.message}</p>
                        <button onclick="loadAdminOrders()" class="mt-3 px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-bold hover:bg-red-200">Retry</button>
                    </div>`;
            }
        }

        async function updateOrderStatus(id, status) {
            if (!confirm(`Change status to ${status}?`)) return;
            try {
                await db.collection('orders').doc(id).update({ status: status });
                loadAdminOrders();
            } catch (e) { alert("Error updating: " + e.message); }
        }

        async function deleteOrder(id) {
            if (!confirm("Delete this order record permanently?")) return;
            await db.collection('orders').doc(id).delete();
            loadAdminOrders();
        }
    </script>
</body>

</html>
